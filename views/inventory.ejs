
<%- include('./partials/head') %>
<%- include('./partials/header', { classifications, isAuth, accountData }) %>

    <%
      const priceFormatter = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" })
      const milesValue = Number(vehicle.inv_miles)
    %>

    <div class="grid">
      <section class="card" aria-label="Vehicle media gallery">
        <div class="card-head">
          <div class="left">This vehicle has passed inspection by an ASE-certified technician.</div>
          <div class="brand">enterprise certified®</div>
        </div>

        <img class="img-lg" src="<%= vehicle.inv_image %>" alt="<%= title %>">
      </section>

      <aside class="panel" aria-label="Vehicle details">
        <div class="title">
          <h1><%= title %></h1>
          <small>No-Haggle dealer listing • Enterprise-style layout replica</small>
        </div>
        <div class="price-row">
          
          <div class="mileage-badge">
            <span class="lbl">MILEAGE</span>
            <span class="val"><%= milesValue.toLocaleString("en-US") %></span>
          </div>
          <div class="price-block">
            <p class="price-title">No-Haggle Price</p>
            <p class="price"><%= priceFormatter.format(vehicle.inv_price) %></p>
            <p class="disclaimer">Does not include $249 Dealer Documentary Service Fee.</p>
          </div>
        </div>

        <div class="est-pay">
          <a href="#" aria-disabled="true">Estimate Payments</a>
        </div>

        <div class="actions">
          <a class="btn primary" href="#" aria-disabled="true">Start My Purchase</a>
          <a class="btn" href="#" aria-disabled="true">Contact Us</a>
          <a class="btn" href="#" aria-disabled="true">Schedule Test Drive</a>
          <a class="btn" href="#" aria-disabled="true">Apply for Financing</a>
        </div>

        <div class="specs">
          <div class="spec"><div class="k">Mileage:</div><div class="v"><%= milesValue.toLocaleString("en-US") %></div></div>
          <div class="spec"><div class="k">Make:</div><div class="v"><%= vehicle.inv_make %></div></div>
          <div class="spec"><div class="k">Model:</div><div class="v"><%= vehicle.inv_model %></div></div>
          <div class="spec"><div class="k">Year:</div><div class="v"><%= vehicle.inv_year %></div></div>

          <div class="spec"><div class="k">Ext. Color:</div><div class="v"><%= vehicle.inv_color %></div></div>

          <div class="spec"><div class="k">Fuel Type:</div><div class="v">Gasoline</div></div>
          <div class="spec"><div class="k">Drivetrain:</div><div class="v">Front Wheel Drive</div></div>

          <div class="spec"><div class="k">Transmission:</div><div class="v">Xtronic CVT</div></div>

          <div class="spec"><div class="k">Description:</div><div class="v"><%= vehicle.inv_description %></div></div>
        </div>

        <div class="stockline">
          <div>Vehicle: <span class="strong">2019 Nissan Sentra SV CVT</span></div>
          <div>Location: <span class="strong">Visit Us</span></div>
        </div>

        <div class="contact">
          <a class="phone">Call Us • 801-396-7886</a>
          <a class="visit">Visit Us • Directions</a>
        </div>
      </aside>
      
      <% if(isAuth && (accountData.account_type === "Employee" || accountData.account_type === "Admin")) { %>
        <form action="/inventory-model/<%= vehicle.inv_id %>" method="POST">
          <button type="submit">Delete</button>
        </form>
      <% } %>

      <section class="card" style="width: 100%; margin-bottom: 20px;" aria-label="Review section">
        <div class="card-head">
          <div class="left"><h3>Reviews</h3></div>
        </div>
        <div class="card-body">

          <% reviews.forEach(r => { %>

          <div>
            <p><b><%= r.account.account_firstname  %> <%= r.account.account_lastname %></b></p>
            <p><%= r.review_text %></p>
            
            <% if (accountData && (accountData.account_type === "Admin" || r.account.account_id === accountData.account_id)) { %>
            <div>
              <form style="display: inline;" action="/review/<%= r.review_id %>/delete" method="POST">
                <button type="submit" style="padding: 2px 5px">Delete</button>
              </form>
              <button class="edit-review" style="padding: 2px 5px">Edit</button>
            </div>
            <div class="hidden">
              <form action="/review/<%= r.review_id %>/edit" method="POST">
                <textarea style="width: 100%; padding: 5px 10px;" name="review_text" id="review_text"><%= r.review_text %></textarea>
                <button type="submit">Update</button>
              </form>
            </div>
            <% } %>

          </div>
          <% }) %>
          
          <% if (isAuth) { %>
          <form action="/review" method="POST">
            <hr style="width: 100%;">
            <p>Create a review</p>
            <textarea style="width: 100%; padding: 5px 10px;" name="review_text" id="review_text"></textarea>
            <input type="hidden" name="inv_id" value="<%= vehicle.inv_id %>">
            <button type="submit">Create</button>
          </form>
          <% } %>
        </div>
      </section>

    </div>

    <script>
      document.querySelectorAll('.edit-review').forEach(btn => {
        btn.addEventListener('click', e => {
          const form = e.target.parentElement.parentElement.children
          form[form.length-1].classList.toggle('hidden')
        })
      })
    </script>

<%- include('./partials/footer') %>